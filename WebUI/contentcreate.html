<!-- contentcreate.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- å…±ç”¨æ ·å¼ -->
    <style>
        .file-picker {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .novel-info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            background: rgba(245, 255, 250, 0.9);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #37c2d4;
        }

        .info-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .info-label {
            color: #00768b;
            font-weight: bold;
            margin-bottom: 8px;
            border-bottom: 2px solid #37c2d4;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <!-- æ–‡ä»¶é€‰æ‹©æ¨¡å— -->
    <div class="file-picker">
        <select id="novelSelector" class="xianxia-input" onchange="loadNovelData(this.value)">
            <option value="">æ­£åœ¨åŠ è½½ä½œå“åˆ—è¡¨...</option>
        </select>
        <button onclick="refreshFileList()" class="random-btn">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
    </div>

    <!-- ä½œå“ä¿¡æ¯å±•ç¤º -->
    <div id="infoContainer" class="novel-info-panel" style="display:none;">
        <div class="info-item">
            <div class="info-label">ğŸ“– ä½œå“åç§°</div>
            <div id="info-title">-</div>
        </div>
        <div class="info-item">
            <div class="info-label">ğŸ­ æ ¸å¿ƒä¸»é¢˜</div>
            <div id="info-theme">-</div>
        </div>
        <div class="info-item">
            <div class="info-label">ğŸ‘¤ ä¸»è§’ä¿¡æ¯</div>
            <div id="info-protagonist">-</div>
        </div>
        <div class="info-item">
            <div class="info-label">ğŸ“œ èƒŒæ™¯è®¾å®š</div>
            <div id="info-background">-</div>
        </div>
        <div class="info-item">
            <div class="info-label">ğŸ“˜ ç« èŠ‚æ€»æ•°</div>
            <div id="info-chapters">-</div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function initFileList() {
            fetch('/api/get-novel-files')
                .then(res => res.json())
                .then(data => {
                    const selector = document.getElementById('novelSelector');
                    selector.innerHTML = data.files.length > 0 
                        ? data.files.map(file => 
                            `<option value="${file.path}" ${file.isLatest ? 'selected' : ''}>
                                ${file.name} (${file.time})
                            </option>`
                          ).join('')
                        : '<option value="">æš‚æ— å†å²ä½œå“</option>';
                    
                    if(data.files.length > 0) loadNovelData(data.files[0].path);
                });
        }

        // åŠ è½½å…·ä½“ä½œå“æ•°æ®
        function loadNovelData(filepath) {
            if(!filepath) return;
            
            fetch(`/api/get-novel-content?path=${encodeURIComponent(filepath)}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('infoContainer').style.display = 'grid';
                    document.getElementById('info-title').textContent = data.title || 'æœªå‘½åä½œå“';
                    document.getElementById('info-theme').textContent = data.theme;
                    document.getElementById('info-protagonist').textContent = data.protagonist;
                    document.getElementById('info-background').textContent = data.background;
                    document.getElementById('info-chapters').textContent = data.chapters || '0';
                });
        }

        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        function refreshFileList() {
            document.getElementById('novelSelector').innerHTML = '<option>åŠ è½½ä¸­...</option>';
            initFileList();
        }

        // åˆå§‹åŒ–æ‰§è¡Œ
        window.onload = initFileList;
    </script>

    <div class="creation-section">
        <!-- å…¨é‡ç« èŠ‚ç”Ÿæˆ -->
        <div class="generation-block">
            <h2>ğŸ“œ å…¨é‡ç« èŠ‚ä¸»çº¿ç”Ÿæˆ</h2>
            <div class="generation-control">
                <button class="action-btn" onclick="generateFullPlot()">
                    ğŸŒ€ ç”Ÿæˆä¸»çº¿å‰§æƒ…
                </button>
            </div>
            <textarea 
                id="fullPlot" 
                class="plot-textarea" 
                placeholder="ç”Ÿæˆçš„ä¸»çº¿å‰§æƒ…å°†åœ¨æ­¤æ˜¾ç¤º..."
            ></textarea>
        </div>

        <!-- å•ç« èŠ‚ç”Ÿæˆ -->
        <div class="generation-block">
            <h2>ğŸ“– å…·ä½“ç« èŠ‚å†…å®¹ç”Ÿæˆ</h2>
            <div class="chapter-control">
                <input 
                    type="number" 
                    id="chapterNum" 
                    class="xianxia-input" 
                    placeholder="è¾“å…¥ç« èŠ‚å·"
                    min="1"
                    value="1"
                >
                <button class="action-btn" onclick="generateChapter()">
                    âœ¨ ç”Ÿæˆæœ¬ç« å†…å®¹
                </button>
            </div>
            <textarea
                id="chapterContent"
                class="plot-textarea"
                placeholder="ç”Ÿæˆçš„ç« èŠ‚å†…å®¹å°†åœ¨æ­¤æ˜¾ç¤º..."
            ></textarea>
        </div>
    </div>

    <style>
        /* æ–°å¢æ ·å¼ */
        .creation-section {
            margin-top: 40px;
            display: grid;
            gap: 40px;
            max-width: 1200px;
            margin: 40px auto;
        }

        .generation-block {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 2px solid #37c2d4;
        }

        .generation-block h2 {
            color: #1a4d5c;
            margin-bottom: 25px;
            text-align: center;
        }

        .plot-textarea {
            width: 100%;
            height: 300px;
            padding: 20px;
            border: 2px solid #37c2d4;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 1.1em;
            line-height: 1.6;
            resize: vertical;
            background: rgba(255,255,255,0.95);
        }

        .chapter-control {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        .chapter-control input {
            width: 120px;
            padding: 12px 15px;
            text-align: center;
        }

        .generation-control {
            text-align: center;
            margin-bottom: 15px;
        }
    </style>

    <script>
        // æ–°å¢äº¤äº’é€»è¾‘
        async function generateFullPlot() {
            const filepath = document.getElementById('novelSelector').value;
            if (!filepath) {
                alert('è¯·å…ˆé€‰æ‹©ä½œå“æ–‡ä»¶');
                return;
            }

            const textarea = document.getElementById('fullPlot');
            textarea.value = 'æ­£åœ¨ç”Ÿæˆä¸»çº¿å‰§æƒ…ï¼ˆå¯èƒ½éœ€è¦3-5åˆ†é’Ÿï¼‰...\nGenerating full plotï¼ˆmay take 3-5 minutesï¼‰...';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000);

                const response = await fetch('/api/generate-plot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ filepath }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                
                const data = await response.json();
                textarea.value = data.success 
                    ? data.plot 
                    : `ç”Ÿæˆå¤±è´¥: ${data.error}`;
                
            } catch (error) {
                textarea.value = `è¯·æ±‚å¼‚å¸¸: ${error.message}`;
            }
        }

        async function generateChapter() {
            const filepath = document.getElementById('novelSelector').value;
            const chapterNum = document.getElementById('chapterNum').value;
            
            if (!filepath || !chapterNum) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            const textarea = document.getElementById('chapterContent');
            textarea.value = 'æ­£åœ¨ç”Ÿæˆç« èŠ‚å†…å®¹...';

            try {
                const response = await fetch('/api/generate-chapter', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filepath,
                        chapter: parseInt(chapterNum)
                    })
                });
                
                const data = await response.json();
                textarea.value = data.success 
                    ? data.content 
                    : `ç”Ÿæˆå¤±è´¥: ${data.error}`;
                
            } catch (error) {
                textarea.value = `è¯·æ±‚å¼‚å¸¸: ${error.message}`;
            }
        }
    </script>
</body>
</html>
